{% if error %}
<div class="error-message">{{ error }}</div>
{% else %}
<div class="weather-section">
    {% for location in locations %}
    <div class="weather-location">
        <h3>{{ location.city }}</h3>
        <p class="weather-current">
            <span class="temp-high">{{ location.current_temp }}°F</span>
            <span class="weather-description">{{ location.current_desc }}</span>
        </p>

        <!-- Temperature chart as SVG - 5 days -->
        <figure title="5-day forecast. Shaded areas are nighttime. Blue markers show precipitation.">
            <svg viewBox="0 0 900 180" class="weather-chart" preserveAspectRatio="xMidYMid meet" style="width: 100%; max-width: 1200px;">
                <title>5-day forecast. Shaded areas are nighttime. Blue markers show precipitation.</title>
                {% set temps = location.hourly[:120] %}
                {% if temps %}
                {% set min_temp = global_min_temp %}
                {% set max_temp = global_max_temp %}
                {% set temp_range = max_temp - min_temp if max_temp != min_temp else 1 %}
                {% set chart_left = 40 %}
                {% set chart_width = 840 %}
                {% set chart_top = 25 %}
                {% set chart_height = 130 %}
                {% set hour_width = chart_width / 120 %}

                <!-- Horizontal grid lines -->
                {% for i in range(5) %}
                {% set grid_y = chart_top + (i * chart_height / 4) %}
                {% set grid_temp = max_temp - (i * temp_range / 4) %}
                <line x1="{{ chart_left }}" y1="{{ grid_y }}" x2="{{ chart_left + chart_width }}" y2="{{ grid_y }}"
                      stroke="#e0e0e0" stroke-width="1"/>
                <text x="{{ chart_left - 5 }}" y="{{ grid_y + 4 }}" font-size="10" fill="#666" text-anchor="end">
                    {{ grid_temp|int }}°
                </text>
                {% endfor %}

                <!-- Background for nighttime hours -->
                {% for hour in temps %}
                {% if hour.is_night %}
                <rect x="{{ chart_left + loop.index0 * hour_width }}" y="{{ chart_top }}"
                      width="{{ hour_width }}" height="{{ chart_height }}"
                      fill="#f0f0f0"/>
                {% endif %}
                {% endfor %}

                <!-- Vertical day dividers -->
                {% for hour in temps %}
                {% if hour.hour == 0 %}
                <line x1="{{ chart_left + loop.index0 * hour_width }}" y1="{{ chart_top }}"
                      x2="{{ chart_left + loop.index0 * hour_width }}" y2="{{ chart_top + chart_height }}"
                      stroke="#ccc" stroke-width="1"/>
                <text x="{{ chart_left + loop.index0 * hour_width + 3 }}" y="{{ chart_top - 8 }}"
                      font-size="11" fill="#333">
                    {{ hour.time_eastern[5:10] }}
                </text>
                {% endif %}
                {% endfor %}

                <!-- Temperature line -->
                <polyline
                    points="{% for hour in temps %}{{ chart_left + loop.index0 * hour_width + hour_width/2 }},{{ chart_top + chart_height - ((hour.temp - min_temp) / temp_range * chart_height) }} {% endfor %}"
                    fill="none"
                    stroke="#333"
                    stroke-width="2"/>

                <!-- Precipitation markers -->
                {% for hour in temps %}
                {% if hour.precip_amount > 0 %}
                {% set precip_x = chart_left + loop.index0 * hour_width + hour_width/2 %}
                {% set precip_height = hour.precip_amount * 80 %}
                <line x1="{{ precip_x }}" y1="{{ chart_top + chart_height }}"
                      x2="{{ precip_x }}" y2="{{ chart_top + chart_height - precip_height }}"
                      stroke="#6699cc" stroke-width="2" stroke-dasharray="2,2" opacity="0.7"/>
                {% if hour.is_snow %}
                <text x="{{ precip_x }}" y="{{ chart_top + chart_height - precip_height - 3 }}"
                      font-size="10" text-anchor="middle" fill="#6699cc">*</text>
                {% else %}
                <circle cx="{{ precip_x }}" cy="{{ chart_top + chart_height - precip_height - 3 }}"
                        r="2" fill="#6699cc"/>
                {% endif %}
                {% endif %}
                {% endfor %}

                {% endif %}
            </svg>
        </figure>

        <!-- Daily precipitation totals -->
        {% if location.daily_precip %}
        <p class="sidenote">
            Daily precip:
            {% for date, data in location.daily_precip.items() %}
            {% if data.amount >= 0.01 %}
            {{ date[5:] }}: {{ "%.1f"|format(data.amount) }}"{% if data.is_snow %}*{% endif %}{% if not loop.last %}, {% endif %}
            {% endif %}
            {% endfor %}
        </p>
        {% endif %}
    </div>
    {% if not loop.last %}<hr>{% endif %}
    {% endfor %}
</div>
{% endif %}
