{% if error %}
<div class="error-message">{{ error }}</div>
{% else %}
<div class="weather-section">
    {% for location in locations %}
    <div class="weather-location">
        <h3>{{ location.city }}</h3>
        <p class="weather-current">
            <span class="temp-high">{{ location.current_temp }}°F</span>
            <span class="weather-description">{{ location.current_desc }}</span>
        </p>

        <!-- Temperature chart as SVG - 5 days -->
        <figure title="5-day forecast. Shaded areas are nighttime. Blue shading shows precipitation.">
            <svg viewBox="0 0 900 450" class="weather-chart" preserveAspectRatio="xMidYMid meet" style="width: 100%; max-width: 1200px;">
                <title>5-day forecast. Shaded areas are nighttime. Blue shading shows precipitation.</title>
                {% set temps = location.hourly[:120] %}
                {% if temps %}
                {% set min_temp = global_min_temp %}
                {% set max_temp = global_max_temp %}
                {% set temp_range = max_temp - min_temp if max_temp != min_temp else 1 %}
                {% set chart_left = 40 %}
                {% set chart_width = 800 %}
                {% set chart_right = chart_left + chart_width %}
                {% set chart_top = 40 %}
                {% set chart_height = 380 %}
                {% set hour_width = chart_width / 120 %}
                {% set precip_max = global_max_precip %}
                {% set precip_scale = chart_height / precip_max %}

                <!-- Horizontal grid lines (temperature on left) -->
                {% for i in range(5) %}
                {% set grid_y = chart_top + (i * chart_height / 4) %}
                {% set grid_temp = max_temp - (i * temp_range / 4) %}
                <line x1="{{ chart_left }}" y1="{{ grid_y }}" x2="{{ chart_right }}" y2="{{ grid_y }}"
                      stroke="#e0e0e0" stroke-width="1"/>
                <text x="{{ chart_left - 5 }}" y="{{ grid_y + 5 }}" font-size="18" fill="#666" text-anchor="end">
                    {{ grid_temp|int }}°
                </text>
                {% endfor %}

                <!-- Right y-axis labels (precipitation in inches) -->
                {% for i in range(6) %}
                {% set precip_val = (5 - i) * precip_max / 5 %}
                {% set grid_y = chart_top + (i * chart_height / 5) %}
                <text x="{{ chart_right + 5 }}" y="{{ grid_y + 5 }}" font-size="18" fill="#2255aa" text-anchor="start">
                    {{ "%.1f"|format(precip_val) }}"
                </text>
                {% endfor %}

                <!-- Background for nighttime hours -->
                {% for hour in temps %}
                {% if hour.is_night %}
                <rect x="{{ chart_left + loop.index0 * hour_width }}" y="{{ chart_top }}"
                      width="{{ hour_width }}" height="{{ chart_height }}"
                      fill="#f0f0f0"/>
                {% endif %}
                {% endfor %}

                <!-- Vertical day dividers -->
                {% for hour in temps %}
                {% if hour.hour == 0 %}
                <line x1="{{ chart_left + loop.index0 * hour_width }}" y1="{{ chart_top }}"
                      x2="{{ chart_left + loop.index0 * hour_width }}" y2="{{ chart_top + chart_height }}"
                      stroke="#ccc" stroke-width="1"/>
                <text x="{{ chart_left + loop.index0 * hour_width + 3 }}" y="{{ chart_top - 12 }}"
                      font-size="18" fill="#333">
                    {{ hour.day_name }}
                </text>
                {% endif %}
                {% endfor %}

                <!-- Precipitation bars (rain=blue, snow=cyan) -->
                {% for hour in temps %}
                {% if hour.precip_amount > 0 %}
                <rect x="{{ chart_left + loop.index0 * hour_width }}"
                      y="{{ chart_top + chart_height - hour.precip_amount * precip_scale }}"
                      width="{{ hour_width }}"
                      height="{{ hour.precip_amount * precip_scale }}"
                      fill="{% if hour.is_snow %}#66ccee{% else %}#3377bb{% endif %}"
                      fill-opacity="0.6"/>
                {% endif %}
                {% endfor %}

                <!-- Daily precipitation labels -->
                {% set ns = namespace(current_date=none, day_precip_total=0, day_start_idx=0, day_is_snow=false) %}
                {% for hour in temps %}
                {% set hour_date = hour.time_eastern[:10] %}
                {% if hour_date != ns.current_date %}
                    {% if ns.current_date and ns.day_precip_total >= 0.05 %}
                    {% set label_x = chart_left + (ns.day_start_idx + (loop.index0 - ns.day_start_idx) / 2) * hour_width %}
                    <text x="{{ label_x }}" y="{{ chart_top + chart_height - 15 }}"
                          font-size="18" fill="{% if ns.day_is_snow %}#338899{% else %}#2255aa{% endif %}" text-anchor="middle" font-weight="bold">
                        {{ "%.1f"|format(ns.day_precip_total) }}"{% if ns.day_is_snow %}❄{% endif %}
                    </text>
                    {% endif %}
                    {% set ns.current_date = hour_date %}
                    {% set ns.day_precip_total = hour.precip_amount %}
                    {% set ns.day_start_idx = loop.index0 %}
                    {% set ns.day_is_snow = hour.is_snow %}
                {% else %}
                    {% set ns.day_precip_total = ns.day_precip_total + hour.precip_amount %}
                    {% if hour.is_snow %}{% set ns.day_is_snow = true %}{% endif %}
                {% endif %}
                {% endfor %}
                <!-- Final day label -->
                {% if ns.day_precip_total >= 0.05 %}
                {% set label_x = chart_left + (ns.day_start_idx + (temps|length - ns.day_start_idx) / 2) * hour_width %}
                <text x="{{ label_x }}" y="{{ chart_top + chart_height - 15 }}"
                      font-size="18" fill="{% if ns.day_is_snow %}#338899{% else %}#2255aa{% endif %}" text-anchor="middle" font-weight="bold">
                    {{ "%.1f"|format(ns.day_precip_total) }}"{% if ns.day_is_snow %}❄{% endif %}
                </text>
                {% endif %}

                <!-- Temperature line -->
                <polyline
                    points="{% for hour in temps %}{{ chart_left + loop.index0 * hour_width + hour_width/2 }},{{ chart_top + chart_height - ((hour.temp - min_temp) / temp_range * chart_height) }} {% endfor %}"
                    fill="none"
                    stroke="#333"
                    stroke-width="2.5"/>

                {% endif %}
            </svg>
        </figure>
    </div>
    {% if not loop.last %}<hr>{% endif %}
    {% endfor %}
</div>
{% endif %}
