{% if error %}
<div class="error-message">{{ error }}</div>
{% else %}
<div class="weather-section">
    {% for location in locations %}
    <div class="weather-location">
        <h3>{{ location.city }}</h3>
        <p class="weather-current">
            <span class="temp-high">{{ location.current_temp }}°F</span>
            <span class="weather-description">{{ location.current_desc }}</span>
        </p>

        <!-- Temperature chart as SVG - 5 days -->
        <figure title="5-day forecast. Shaded areas are nighttime. Blue shading shows precipitation.">
            <svg viewBox="0 0 900 450" class="weather-chart" preserveAspectRatio="xMidYMid meet" style="width: 100%; max-width: 1200px;">
                <title>5-day forecast. Shaded areas are nighttime. Blue shading shows precipitation.</title>
                {% set temps = location.hourly[:120] %}
                {% if temps %}
                {% set min_temp = global_min_temp %}
                {% set max_temp = global_max_temp %}
                {% set temp_range = max_temp - min_temp if max_temp != min_temp else 1 %}
                {% set chart_left = 40 %}
                {% set chart_width = 800 %}
                {% set chart_right = chart_left + chart_width %}
                {% set chart_top = 40 %}
                {% set chart_height = 380 %}
                {% set hour_width = chart_width / 120 %}
                {% set precip_max = global_max_precip %}
                {% set precip_scale = chart_height / precip_max %}

                <!-- Horizontal grid lines (temperature on left) -->
                {% for i in range(5) %}
                {% set grid_y = chart_top + (i * chart_height / 4) %}
                {% set grid_temp = max_temp - (i * temp_range / 4) %}
                <line x1="{{ chart_left }}" y1="{{ grid_y }}" x2="{{ chart_right }}" y2="{{ grid_y }}"
                      stroke="#e0e0e0" stroke-width="1"/>
                <text x="{{ chart_left - 5 }}" y="{{ grid_y + 5 }}" font-size="18" fill="#666" text-anchor="end">
                    {{ grid_temp|int }}°
                </text>
                {% endfor %}

                <!-- Right y-axis labels (precipitation in inches) -->
                {% for i in range(6) %}
                {% set precip_val = (5 - i) * precip_max / 5 %}
                {% set grid_y = chart_top + (i * chart_height / 5) %}
                <text x="{{ chart_right + 5 }}" y="{{ grid_y + 5 }}" font-size="18" fill="#2255aa" text-anchor="start">
                    {{ "%.1f"|format(precip_val) }}"
                </text>
                {% endfor %}

                <!-- Background for nighttime hours -->
                {% for hour in temps %}
                {% if hour.is_night %}
                <rect x="{{ chart_left + loop.index0 * hour_width }}" y="{{ chart_top }}"
                      width="{{ hour_width }}" height="{{ chart_height }}"
                      fill="#f0f0f0"/>
                {% endif %}
                {% endfor %}

                <!-- Vertical day dividers -->
                {% for hour in temps %}
                {% if hour.hour == 0 %}
                <line x1="{{ chart_left + loop.index0 * hour_width }}" y1="{{ chart_top }}"
                      x2="{{ chart_left + loop.index0 * hour_width }}" y2="{{ chart_top + chart_height }}"
                      stroke="#ccc" stroke-width="1"/>
                <text x="{{ chart_left + loop.index0 * hour_width + 3 }}" y="{{ chart_top - 12 }}"
                      font-size="18" fill="#333">
                    {{ hour.time_eastern[5:10] }}
                </text>
                {% endif %}
                {% endfor %}

                <!-- Precipitation area (shaded region) -->
                <polygon
                    points="{{ chart_left }},{{ chart_top + chart_height }} {% for hour in temps %}{{ chart_left + loop.index0 * hour_width + hour_width/2 }},{{ chart_top + chart_height - hour.precip_amount * precip_scale }} {% endfor %}{{ chart_right }},{{ chart_top + chart_height }}"
                    fill="#3377bb"
                    fill-opacity="0.5"
                    stroke="none"/>

                <!-- Precipitation line -->
                <polyline
                    points="{% for hour in temps %}{{ chart_left + loop.index0 * hour_width + hour_width/2 }},{{ chart_top + chart_height - hour.precip_amount * precip_scale }} {% endfor %}"
                    fill="none"
                    stroke="#2255aa"
                    stroke-width="2.5"/>

                <!-- Daily precipitation labels -->
                {% set current_date = none %}
                {% set day_precip_total = 0 %}
                {% set day_start_idx = 0 %}
                {% for hour in temps %}
                {% set hour_date = hour.time_eastern[:10] %}
                {% if hour_date != current_date %}
                    {% if current_date and day_precip_total >= 0.05 %}
                    {% set label_x = chart_left + (day_start_idx + (loop.index0 - day_start_idx) / 2) * hour_width %}
                    <text x="{{ label_x }}" y="{{ chart_top + chart_height - 12 }}"
                          font-size="18" fill="#2255aa" text-anchor="middle" font-weight="bold">
                        {{ "%.1f"|format(day_precip_total) }}"
                    </text>
                    {% endif %}
                    {% set current_date = hour_date %}
                    {% set day_precip_total = hour.precip_amount %}
                    {% set day_start_idx = loop.index0 %}
                {% else %}
                    {% set day_precip_total = day_precip_total + hour.precip_amount %}
                {% endif %}
                {% endfor %}

                <!-- Temperature line -->
                <polyline
                    points="{% for hour in temps %}{{ chart_left + loop.index0 * hour_width + hour_width/2 }},{{ chart_top + chart_height - ((hour.temp - min_temp) / temp_range * chart_height) }} {% endfor %}"
                    fill="none"
                    stroke="#333"
                    stroke-width="2.5"/>

                {% endif %}
            </svg>
        </figure>
    </div>
    {% if not loop.last %}<hr>{% endif %}
    {% endfor %}
</div>
{% endif %}
