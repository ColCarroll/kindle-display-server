{% if error %}
<div class="error-message">{{ error }}</div>
{% else %}
<div class="weather-section">
    {% for location in locations %}
    <div class="weather-location">
        <div class="weather-location-header">
            <h3>{{ location.city }}</h3>
            {% if location.location_id %}
            <button class="delete-location-btn"
                    hx-delete="/weather/locations/{{ location.location_id }}"
                    hx-confirm="Remove {{ location.city }}?"
                    hx-swap="none"
                    title="Remove location">×</button>
            {% endif %}
        </div>
        <p class="weather-current">
            <span class="temp-high">{{ location.current_temp }}°F</span>
            {% if location.current_feels_like and (location.current_feels_like - location.current_temp)|abs >= 3 %}
            <span class="feels-like">(feels {{ location.current_feels_like }}°)</span>
            {% endif %}
            <span class="weather-description">{{ location.current_desc }}</span>
        </p>

        <!-- Temperature chart as SVG - 5 days -->
        <div class="weather-chart-container" title="5-day forecast. Shaded areas are nighttime. Blue/cyan bars show precipitation probability (rain/snow).">
            <svg viewBox="0 0 900 300" class="weather-chart" preserveAspectRatio="xMidYMid meet">
                <title>5-day forecast. Shaded areas are nighttime. Blue/cyan bars show precipitation probability (rain/snow).</title>
                {% set temps = location.hourly[:120] %}
                {% if temps %}
                {% set min_temp = global_min_temp %}
                {% set max_temp = global_max_temp %}
                {% set temp_range = max_temp - min_temp if max_temp != min_temp else 1 %}
                {% set chart_left = 40 %}
                {% set chart_width = 800 %}
                {% set chart_right = chart_left + chart_width %}
                {% set chart_top = 30 %}
                {% set chart_height = 240 %}
                {% set hour_width = chart_width / 120 %}

                <!-- Horizontal grid lines (temperature on left) -->
                {% for i in range(5) %}
                {% set grid_y = chart_top + (i * chart_height / 4) %}
                {% set grid_temp = max_temp - (i * temp_range / 4) %}
                <line x1="{{ chart_left }}" y1="{{ grid_y }}" x2="{{ chart_right }}" y2="{{ grid_y }}"
                      stroke="#e0e0e0" stroke-width="1"/>
                <text x="{{ chart_left - 5 }}" y="{{ grid_y + 5 }}" font-size="18" fill="#666" text-anchor="end">
                    {{ grid_temp|int }}°
                </text>
                {% endfor %}

                <!-- Right y-axis labels (precipitation probability %) -->
                {% for i in range(3) %}
                {% set prob_val = (2 - i) * 50 %}
                {% set grid_y = chart_top + (i * chart_height / 2) %}
                <text x="{{ chart_right + 5 }}" y="{{ grid_y + 5 }}" font-size="18" fill="#2255aa" text-anchor="start">
                    {{ prob_val }}%
                </text>
                {% endfor %}

                <!-- Background for nighttime hours -->
                {% for hour in temps %}
                {% if hour.is_night %}
                <rect x="{{ chart_left + loop.index0 * hour_width }}" y="{{ chart_top }}"
                      width="{{ hour_width }}" height="{{ chart_height }}"
                      fill="#f0f0f0"/>
                {% endif %}
                {% endfor %}

                <!-- Vertical day dividers -->
                {% for hour in temps %}
                {% if hour.hour == 0 %}
                <line x1="{{ chart_left + loop.index0 * hour_width }}" y1="{{ chart_top }}"
                      x2="{{ chart_left + loop.index0 * hour_width }}" y2="{{ chart_top + chart_height }}"
                      stroke="#ccc" stroke-width="1"/>
                <text x="{{ chart_left + loop.index0 * hour_width + 3 }}" y="{{ chart_top - 12 }}"
                      font-size="18" fill="#333">
                    {{ hour.day_name }}
                </text>
                {% endif %}
                {% endfor %}

                <!-- Precipitation probability bars (rain=blue, snow=cyan) -->
                {% for hour in temps %}
                {% if hour.precip_prob > 0 %}
                {% set bar_height = hour.precip_prob / 100 * chart_height %}
                <rect x="{{ chart_left + loop.index0 * hour_width }}"
                      y="{{ chart_top + chart_height - bar_height }}"
                      width="{{ hour_width }}"
                      height="{{ bar_height }}"
                      fill="{% if hour.is_snow %}#66ccee{% else %}#3377bb{% endif %}"
                      fill-opacity="0.5"/>
                {% endif %}
                {% endfor %}

                <!-- Daily precipitation amount labels -->
                {% set ns = namespace(current_date=none, day_precip_total=0, day_start_idx=0, day_is_snow=false) %}
                {% for hour in temps %}
                {% set hour_date = hour.time_eastern[:10] %}
                {% if hour_date != ns.current_date %}
                    {% if ns.current_date and ns.day_precip_total >= 0.05 %}
                    {% set label_x = chart_left + (ns.day_start_idx + (loop.index0 - ns.day_start_idx) / 2) * hour_width %}
                    <text x="{{ label_x }}" y="{{ chart_top + chart_height - 15 }}"
                          font-size="16" fill="{% if ns.day_is_snow %}#338899{% else %}#2255aa{% endif %}" text-anchor="middle" font-weight="bold">
                        {{ "%.1f"|format(ns.day_precip_total) }}"{% if ns.day_is_snow %}❄{% endif %}
                    </text>
                    {% endif %}
                    {% set ns.current_date = hour_date %}
                    {% set ns.day_precip_total = hour.precip_amount %}
                    {% set ns.day_start_idx = loop.index0 %}
                    {% set ns.day_is_snow = hour.is_snow %}
                {% else %}
                    {% set ns.day_precip_total = ns.day_precip_total + hour.precip_amount %}
                    {% if hour.is_snow %}{% set ns.day_is_snow = true %}{% endif %}
                {% endif %}
                {% endfor %}
                <!-- Final day label -->
                {% if ns.day_precip_total >= 0.05 %}
                {% set label_x = chart_left + (ns.day_start_idx + (temps|length - ns.day_start_idx) / 2) * hour_width %}
                <text x="{{ label_x }}" y="{{ chart_top + chart_height - 15 }}"
                      font-size="16" fill="{% if ns.day_is_snow %}#338899{% else %}#2255aa{% endif %}" text-anchor="middle" font-weight="bold">
                    {{ "%.1f"|format(ns.day_precip_total) }}"{% if ns.day_is_snow %}❄{% endif %}
                </text>
                {% endif %}

                <!-- Feels-like temperature line (wind chill=blue, heat index=red) -->
                {% set first_feels = temps[0].feels_like if temps else 0 %}
                {% set first_temp = temps[0].temp if temps else 0 %}
                {% set feels_color = '#3377cc' if first_feels <= first_temp else '#cc3333' %}
                <polyline
                    points="{% for hour in temps %}{{ chart_left + loop.index0 * hour_width + hour_width/2 }},{{ chart_top + chart_height - ((hour.feels_like - min_temp) / temp_range * chart_height) }} {% endfor %}"
                    fill="none"
                    stroke="{{ feels_color }}"
                    stroke-width="1.5"
                    stroke-opacity="0.7"/>

                <!-- Temperature line -->
                <polyline
                    points="{% for hour in temps %}{{ chart_left + loop.index0 * hour_width + hour_width/2 }},{{ chart_top + chart_height - ((hour.temp - min_temp) / temp_range * chart_height) }} {% endfor %}"
                    fill="none"
                    stroke="#333"
                    stroke-width="2.5"/>

                {% endif %}
            </svg>
        </div>
    </div>
    {% if not loop.last %}<hr>{% endif %}
    {% endfor %}

    <!-- More/Less weather toggle -->
    <div class="weather-toggle">
        {% if show_all %}
        <a href="#"
           hx-get="/partials/weather"
           hx-target="#weather-container"
           hx-swap="innerHTML"
           class="weather-toggle-link">▲ Less weather</a>

        <!-- Add location form (only shown when expanded) -->
        <div class="add-location-form">
            <form hx-post="/weather/locations"
                  hx-swap="none"
                  hx-target="#add-location-error">
                <input type="text" name="name" placeholder="Name (e.g. Home)" required>
                <input type="text" name="zip_code" placeholder="Zip code" required pattern="[0-9]{5}" maxlength="5">
                <button type="submit">Add Location</button>
            </form>
            <div id="add-location-error"></div>
        </div>
        {% else %}
        <a href="#"
           hx-get="/partials/weather?show_all=true"
           hx-target="#weather-container"
           hx-swap="innerHTML"
           class="weather-toggle-link">▼ More weather</a>
        {% endif %}
    </div>
</div>

<!-- Refresh weather when locations change -->
<script>
document.body.addEventListener('locationsChanged', function(evt) {
    // Stay in expanded view after adding/deleting
    htmx.ajax('GET', '/partials/weather?show_all=true', {target: '#weather-container', swap: 'innerHTML'});
});
// Also listen for htmx:afterRequest in case the custom event doesn't fire
document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.pathInfo && evt.detail.pathInfo.requestPath && evt.detail.pathInfo.requestPath.includes('/weather/locations')) {
        htmx.ajax('GET', '/partials/weather?show_all=true', {target: '#weather-container', swap: 'innerHTML'});
    }
});
</script>

<style>
.weather-section,
.weather-section * {
    max-width: none !important;
}

.weather-section {
    width: 100%;
    max-width: 900px !important;
}

.weather-location {
    width: 100% !important;
}

.weather-section h3,
.weather-section p,
.weather-section hr {
    width: 100% !important;
}

.weather-chart-container {
    width: 100% !important;
    margin: 1rem 0;
}

.weather-chart {
    width: 100% !important;
    height: auto;
}

.weather-location-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.weather-location-header h3 {
    margin: 0;
}

.delete-location-btn {
    background: none;
    border: none;
    color: #999;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0 0.3rem;
    line-height: 1;
}

.delete-location-btn:hover {
    color: #c00;
}

.add-location-form {
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid #ddd;
}

.add-location-form form {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    align-items: center;
}

.add-location-form input {
    padding: 0.4rem 0.6rem;
    border: 1px solid #ccc;
    border-radius: 3px;
    font-size: 0.9rem;
}

.add-location-form input[name="name"] {
    width: 120px;
}

.add-location-form input[name="zip_code"] {
    width: 80px;
}

.add-location-form button {
    padding: 0.4rem 0.8rem;
    background: #333;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.9rem;
}

.add-location-form button:hover {
    background: #555;
}

.error-message {
    color: #c00;
    margin-top: 0.5rem;
    font-size: 0.9rem;
}

.weather-toggle {
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid #ddd;
}

.weather-toggle-link {
    color: #555;
    text-decoration: none;
    font-size: 0.95rem;
}

.weather-toggle-link:hover {
    color: #000;
}

.feels-like {
    color: #666;
    font-size: 0.9em;
    margin-left: 0.3rem;
}
</style>
{% endif %}
