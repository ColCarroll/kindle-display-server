{% if error %}
<div class="error-message">{{ error }}</div>
{% else %}
<div class="weather-section">
    {% for location in locations %}
    <div class="weather-location">
        <h3>{{ location.city }}</h3>
        <p class="weather-current">
            <span class="temp-high">{{ location.current_temp }}°F</span>
            <span class="weather-description">{{ location.current_desc }}</span>
        </p>

        <!-- Temperature chart as SVG -->
        <figure>
            <svg viewBox="0 0 600 150" class="weather-chart" preserveAspectRatio="xMidYMid meet">
                <!-- Background for nighttime hours -->
                {% for hour in location.hourly[:48] %}
                {% if hour.is_night %}
                <rect x="{{ loop.index0 * 12.5 }}" y="0" width="12.5" height="150"
                      fill="#f0f0f0"/>
                {% endif %}
                {% endfor %}

                <!-- Temperature line -->
                {% set temps = location.hourly[:48] %}
                {% if temps %}
                {% set min_temp = temps|map(attribute='temp')|min %}
                {% set max_temp = temps|map(attribute='temp')|max %}
                {% set temp_range = max_temp - min_temp if max_temp != min_temp else 1 %}
                <polyline
                    points="{% for hour in temps %}{{ loop.index0 * 12.5 + 6.25 }},{{ 140 - ((hour.temp - min_temp) / temp_range * 120) }} {% endfor %}"
                    fill="none"
                    stroke="#333"
                    stroke-width="2"/>

                <!-- Temperature labels at start and end -->
                <text x="10" y="{{ 140 - ((temps[0].temp - min_temp) / temp_range * 120) - 5 }}"
                      font-size="11" fill="#333">{{ temps[0].temp }}°</text>

                <!-- Precipitation markers -->
                {% for hour in temps %}
                {% if hour.precip_amount > 0 %}
                <line x1="{{ loop.index0 * 12.5 + 6.25 }}" y1="145"
                      x2="{{ loop.index0 * 12.5 + 6.25 }}" y2="{{ 145 - hour.precip_amount * 100 }}"
                      stroke="#6699cc" stroke-width="3" stroke-dasharray="2,2" opacity="0.7"/>
                {% if hour.is_snow %}
                <text x="{{ loop.index0 * 12.5 + 6.25 }}" y="{{ 145 - hour.precip_amount * 100 - 3 }}"
                      font-size="10" text-anchor="middle">*</text>
                {% else %}
                <circle cx="{{ loop.index0 * 12.5 + 6.25 }}" cy="{{ 145 - hour.precip_amount * 100 - 3 }}"
                        r="3" fill="#6699cc"/>
                {% endif %}
                {% endif %}
                {% endfor %}

                <!-- Day labels -->
                {% set current_day = none %}
                {% for hour in temps %}
                {% set hour_eastern = hour.time_eastern[:10] %}
                {% if hour.hour == 0 %}
                <line x1="{{ loop.index0 * 12.5 }}" y1="0" x2="{{ loop.index0 * 12.5 }}" y2="150"
                      stroke="#ccc" stroke-width="1"/>
                {% endif %}
                {% if hour.hour == 12 and hour_eastern != current_day %}
                <text x="{{ loop.index0 * 12.5 }}" y="12" font-size="10" fill="#666">
                    {{ hour.time_eastern[5:10] }}
                </text>
                {% endif %}
                {% endfor %}
                {% endif %}
            </svg>
            <figcaption>48-hour forecast. Shaded areas are nighttime.</figcaption>
        </figure>

        <!-- Daily precipitation totals -->
        {% if location.daily_precip %}
        <p class="sidenote">
            Daily precip:
            {% for date, data in location.daily_precip.items() %}
            {% if data.amount >= 0.01 %}
            {{ date[5:] }}: {{ "%.1f"|format(data.amount) }}"{% if data.is_snow %}*{% endif %}{% if not loop.last %}, {% endif %}
            {% endif %}
            {% endfor %}
        </p>
        {% endif %}
    </div>
    {% if not loop.last %}<hr>{% endif %}
    {% endfor %}
</div>
{% endif %}
